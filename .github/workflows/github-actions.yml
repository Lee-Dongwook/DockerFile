name: CI/CD using Github Actions and Docker

on: 
    push:
        branches: ["main"]

permissions: 
    contents: read

jobs: 
    CI-CD:
        runs-on: ubuntu-latest
        steps:
            - name: checkout source code
              uses: actions/checkout@v2
            
            - name: node.js version check
              uses: actions/setup-node@v2
              with:
                node-version: 18
            
            - name: Build React App
              run: yarn run build
              working-directory: './client'

            - name: Docker build & push to prod
              if: contains(github.ref, 'main')
              run: |
                docker login -u ${{secrets.DOCKER_USERNAME}} -p ${{secrets.DOCKER_PASSWORD}}
                docker build -f Dockerfile -t ${{secrets.DOCKER_USERNAME}}/docker-test-prod
                docker push ${{secrets.DOCKER_USERNAME}}/docker-test-prod

            - name: Deploy to prod
              uses: appleboy/ssh-action@master
              id: deploy-prod
              if: contains(github.ref, 'main')
              with:
                host: ${{secrets.HOST_PROD}} # EC2 Pubic Ipv4 DNS
                username: ubuntu
                key: ${{secrets.PRIVATE_KEY}}
                envs: GITHUB_SHA
                script: |
                    sudo docker ps
                    sudo docker pull ${{secrets.DOCKER_USERNAME}}/docker-test-prod
                    sudo docker run -d -p 3000:3000 ${{secrets.DOCKER_USERNAME}}/docker-test-prod
                    sudo docker image prune -f
                
              
            


